import json
from fastapi import HTTPException
from google import genai

# Initialize the Gemini API client
client = genai.Client(api_key="AIzaSyBJOLi_gagdpah-Szh75G_SbhF9ts_Ok38")

def map_query_to_category(client_query: str) -> str:
    """
    Uses the Gemini API to map a client query (in Arabic) to a craftsmen category.
    Returns the detected category as a string.
    """
    prompt = f"""
أنت مساعد تصنيف ذكي. بناءً على وصف مشكلة العميل، حدد نوع الحرفي المطلوب من القائمة أدناه.
يُرجى إعادة النتيجة في صيغة JSON تحتوي على المفتاح "الفئة" فقط، دون أي شرح أو معلومات إضافية.

هذه قائمة الحرف والتخصصات التي يمكن أن يسأل عنها العميل مع شرح موجز لكل منها:

1. نجار موبيليا:
   - يقوم بعمل غرف النوم والركن والانتريه والمكتبات وغرف الأطفال والسفرة. متخصص في صناعة الأثاث المنزلي وتجهيزه.

2. نجار باب وشباك:
   - يقوم بعمل الأبواب والنوافذ الخشبية وإصلاحها، إضافةً إلى البلكونات الخشبية والسلالم والأرضيات الباركيه.

3. كهربائي:
   - فني متخصص في تركيب وصيانة الأنظمة الكهربائية في المباني السكنية. يشمل عمله تركيب المفاتيح والمنافذ والقواطع، صيانة الأعطال الكهربائية، وإصلاح مشكلات التيار أو الأسلاك، بالإضافة إلى توصيل الدوائر وتركيب الإنارة.

4. سباك:
   - فني متخصص في تركيب وصيانة أنظمة المياه والصرف الصحي. يقوم بتركيب وإصلاح الأنابيب والصمامات والمضخات والخزانات والحنفيات ودورات المياه، والكشف عن التسريبات وإصلاحها.

5. نقاش (دهان):
   - حرفي متخصص في تشطيب وتجديد الجدران والأسطح باستخدام الدهانات ومواد الديكور. يشمل عمله تحضير الأسطح، اختيار الألوان، تطبيق الدهانات، وتنفيذ التصاميم الزخرفية.

6. نجار مسلح:
   - عامل بناء متخصص في تجهيز وصب الهياكل الخرسانية بتركيب وتجهيز قوالب (شدات) الخشب أو المعدن للأساسات والأعمدة والكمرات والأسقف.

7. مبيض محارة:
   - عامل بناء متخصص في تجهيز وتشطيب الأسطح والجدران بالمونة الأسمنتية (المحارة) لجعلها ملساء ومتينة قبل الطلاء أو الديكورات.

8. حداد مسلح:
   - متخصص في تجهيز وتركيب حديد التسليح المستخدم في الهياكل الخرسانية. يقوم بقص وتشكيل وثني القضبان الحديدية وفقًا للمخططات الهندسية وربطها قبل صب الخرسانة.

9. مبلط سيراميك:
   - فني متخصص في تركيب وتنسيق بلاط السيراميك والرخام والبورسلين على الأرضيات والجدران. يشمل عمله قياس وتقطيع البلاط، تحضير الأسطح، وضبط المحاذاة والفواصل.

10. ﺟﺑﺳن ﺑورد ﻓﻧﻲ :
   - متخصص في تركيب وتشكيل ألواح الجبس (الجبس بورد) للأسقف المعلقة والحوائط الداخلية، بما يحقق حلولًا ديكورية وعزلًا للصوت والحرارة.

11. الوميتال
   - متخصص في تصميم وتركيب وصيانة النوافذ والأبواب والهياكل المصنوعة من الألمنيوم والزجاج، مثل المطابخ والواجهات الزجاجية.

12. فني تركيبات:
   - متخصص في تركيب وتشغيل وصيانة الأجهزة والأنظمة المنزلية الحديثة (مثل أجهزة التكييف، أنظمة المراقبة، السخانات الكهربائية، وغيرها).

13. لحام:
   - متخصص في توصيل وتصليح الهياكل والمعدات المعدنية. يشمل عمله إصلاح الأبواب الحديدية والنوافذ والأسوار، وتركيب هياكل معدنية جديدة مثل المظلات وحوامل التكييف.

14. دكتور ديكور:
   - مصمم أو مهندس ديكور داخلي متخصص في وضع التصاميم الداخلية وتنسيق الألوان والإضاءة والأثاث. يقوم بإعداد المخططات والإشراف على التنفيذ لتحقيق أفضل شكل جمالي ووظيفي للمساحة.

15. بناء:
   - عامل بناء (بَنَّاء) متخصص في بناء الجدران والأعمدة والأسقف باستخدام الطوب أو البلوك أو الحجر. يقوم بخلط مواد البناء وضبط الاستقامة والزوايا، وأحيانًا ينسق مع الحرفيين الآخرين في الموقع.

16. شريط مداد:
   - متخصص في تركيب شريط المداد لمنع تسرب المياه والهواء في أماكن التقاء الألواح أو الأسطح والجدران.

17. حداد كريتال:
   - فني متخصص في تصميم وتصنيع وتركيب الشرفات المعدنية والدرابزينات. يشمل عمله قص وثني ولحام المقاطع المعدنية وتركيبها بأمان خارج واجهة المبنى.

18. حجر فرعوني:
   - عامل متخصص في تركيب وصقل الرخام والحجر الطبيعي للأرضيات والجدران. يقوم بقياس الأبعاد وقص الرخام وتركيبه وتلميعه.

19. راﻓﻌﺔ اﺛﺎث:
   - ھﻲ أداة أو آﻟﺔ ﺗُﺳﺗﺧدم ﻟﻧﻘل اﻷﺛﺎث واﻷﻏراض اﻟﺛﻘﯾﻠﺔ أو اﻟﻛﺑﯾرة ﻣن اﻟطواﺑق اﻟﻌﻠﯾﺎ ﻓﻲ اﻟﻣﺑﺎﻧﻲ إﻟﻰ اﻷﺳﻔل أو اﻟﻌﻛس، دون اﻟﺣﺎﺟﺔ إﻟﻰ ﺟﮭد ﺑدﻧﻲ ﻛﺑﯾر أو ﺗﻌرﯾض اﻷﺛﺎث ﻟﻠﺗﻠف ﺗُﺟﻧﺑك ﻋﻧﺎء ﺣﻣل اﻷﺛﺎث ﻋﺑر اﻟﺳﻼﻟم، ﻣﻣﺎ ﯾوﻓر اﻟوﻗت واﻟﺟﮭد وﯾﻘﻠل ﺧطر اﻹﺻﺎﺑﺎت وﺗﻘوم ﺑرﻓﻊ ااﻟرﻛن واﻟﺟﮭزة اﻟﻛﮭرﺑﺎﺋﯾﺔ

20. وﻧش ﺑﻧﺎء :
   - ھو أﺣد أھم اﻟﻣﻌدات اﻟﻣﺳﺗﺧدﻣﺔ ﻓﻲ ﻣواﻗﻊ اﻟﺑﻧﺎء،وﯾﺳﺗﺧدم ﻓﻲ رﻓﻊ اﻟطوب واﻻﺳﻣﻧت واﻟرﺧﺎم وﻛل اﻟﻣﺳﺗﺧدﻣﺔ ﻓﻲ ﺻب اﻟﺧرﺳﺎﻧﺎت ورﻓﻊ وﻧﻘل اﻟﻣواد اﻟﺛﻘﯾله 

21. اﻧﺗرﻟوك:
   - ﺑﻼط اﻷرﺻﻔﺔ اﻟﻣﺗداﺧل ﻣﺻﻧوع ﻣن اﻟﺧرﺳﺎﻧﺔ أو اﻟﺑﻼﺳﺗﯾك، ﯾُﺳﺗﺧدم ﻓﻲ رﺻف اﻟﻣﻣرات، اﻟطرق، اﻟﻣواﻗف،اﻷﻓﻧﯾﺔ، واﻷرﺻﻔﺔ


مثال 1:
العميل: "بابي مكسور ويحتاج إلى تصليح."
الفئة: {{"الفئة": "نجار الباب والشباك"}}

مثال 2:
العميل: "يوجد تسريب في حوض المطبخ."
الفئة: {{"الفئة": "سباك"}}

الآن، بناءً على المشكلة التالية، حدد الفئة المناسبة:
العميل: "{client_query}"
الفئة:
    """
    try:
        # Call the Gemini API to get the response
        response = client.models.generate_content(model='gemini-2.0-flash', contents=prompt)
        
        raw_text = response.text.strip()
        
        # Debug: Print raw response text
        print("Raw response from Gemini API:", raw_text)
        
        # Remove code fences if present
        if raw_text.startswith("```"):
            lines = raw_text.splitlines()
            if lines[0].startswith("```"):
                lines = lines[1:]
            if lines and lines[-1].startswith("```"):
                lines = lines[:-1]
            raw_text = "\n".join(lines).strip()
        
        # Try to parse the response as JSON
        parsed = json.loads(raw_text)
        
        # Return the category if available
        category = parsed.get("الفئة", "")
        if not category:
            raise HTTPException(status_code=500, detail="Category not found in response")
        
        return category

    except Exception as e:
        # Handle exceptions and provide a detailed error message
        raise HTTPException(status_code=500, detail=f"Error in map_query_to_category: {str(e)}")
